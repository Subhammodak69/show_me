{% extends "enduser/base.html" %}
{% load static %}

{% block title %}Login | Show_me{% endblock %}

{% block content %}
<!-- Login Wrapper -->
<div class="d-flex align-items-center justify-content-center min-vh-100 " style="width: 100%;">
  <div class="card shadow-lg border-0 rounded-4" style="max-width: 370px; top: 20%;position: absolute;width: 90%;">
    <div class="card-body p-4">
      <div class="d-flex flex-column align-items-center mb-4">
        <img src="{% static 'logo/logo.jpg' %}" alt="Logo" width="100" class="mb-2" loading="lazy"/>
        <h2 class="fw-bold mb-1">Welcome</h2>
        <div class="text-muted mb-1">Login to your account</div>
      </div>

      <!-- Message Display -->
      <div id="login-message" class="mb-3 text-center"></div>

      <form id="loginForm" autocomplete="on" novalidate>
        {% csrf_token %}
        <div class="form-floating mb-3">
          <input type="email" class="form-control" id="email" name="email" placeholder="Email address" required>
          <label for="email"><i class="bi bi-envelope-at"></i> Email address</label>
        </div>
        <div class="form-floating mb-3 position-relative">
          <input type="password" class="form-control" id="password" name="password" placeholder="Password" required>
          <label for="password"><i class="bi bi-lock"></i> Password</label>
          <button type="button" class="btn btn-sm btn-outline-secondary position-absolute end-0 top-50 translate-middle-y me-2 px-2" id="togglePassword" tabindex="-1" style="z-index:2;"><i class="bi bi-eye"></i></button>
        </div>
        <div class="d-grid">
          <button type="submit" class="btn btn-primary fw-semibold py-2">Sign In</button>
        </div>
      </form>

      <div class="text-center mt-4 small">
        Don't have an account? <a href="/signin/" class="fw-semibold">Sign Up</a>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap Icons CDN for the envelope/lock/eye icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css" />

<script>
// Password Toggle
const passwordField = document.getElementById("password");
const togglePassword = document.getElementById("togglePassword");
togglePassword.addEventListener("click", function () {
    const type = passwordField.type === "password" ? "text" : "password";
    passwordField.type = type;
    this.innerHTML = `<i class="bi bi-eye${type === 'password' ? '' : '-slash'}"></i>`;
});

const loginForm = document.getElementById("loginForm");
const messageBox = document.getElementById("login-message");

loginForm.addEventListener("submit", async function (e) {
    e.preventDefault();
    const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;
    const email = document.getElementById("email").value;
    const password = passwordField.value;

    messageBox.innerHTML = '<div class="text-muted">Checking credentials...</div>';

    const response = await fetch("{% url 'log_in' %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": csrfToken,
            "Content-Type": "application/json",
        },
        body: JSON.stringify({ email, password }),
    });

    const data = await response.json();
    messageBox.innerHTML = "";

    if (data.success) {
        messageBox.innerHTML = `<div class="alert alert-success">Login successful! Redirecting...</div>`;
        setTimeout(() => {
            window.location.href = "/";
        }, 800);
    } else {
        messageBox.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
    }
});
</script>
{% endblock %}
