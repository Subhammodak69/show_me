{% extends "enduser/base.html" %}
{% load static %}

{% block title %}Forget Password | Show_me{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-center min-vh-100 m-4">
  <div class="card shadow border-0 rounded-4" style="max-width: 420px; width:90%; top: 20%; position: absolute;">
    <div class="card-body p-4">
      <div class="mb-3 text-center">
        <img src="{% static 'logo/logo.jpg' %}" alt="Logo" width="100" class="mb-2" />
        <h3 class="fw-bold mb-1">Reset Password</h3>
        <p class="text-muted mb-3">Enter your email and new password</p>
      </div>
      
      <!-- Spinner -->
      <div class="justify-content-center mb-3" id="spinner" style="display: none;">
        <div class="spinner-border text-primary" style="width:2.5rem;height:2.5rem;" role="status"></div>
      </div>
      
      <!-- Messages -->
      <div id="msg-box" class="mb-3"></div>
      
      <!-- Single Reset Form -->
      <form id="resetForm" class="needs-validation" novalidate autocomplete="off">
        {% csrf_token %}
        
        <!-- Email -->
        <div class="mb-3">
          <div class="form-floating">
            <input type="email" class="form-control" id="email" name="email" placeholder="Email Address" required>
            <label for="email">Email Address</label>
          </div>
        </div>
        
        <!-- New Password -->
        <div class="mb-3">
          <div class="form-floating position-relative">
            <input type="password" class="form-control" id="newPassword" name="new_password" placeholder="New Password" required minlength="8">
            <label for="newPassword">New Password</label>
            <button type="button" class="btn btn-sm btn-outline-secondary position-absolute top-50 end-0 translate-middle-y me-2"
              id="togglePassword" tabindex="-1">
              <i class="bi bi-eye"></i>
            </button>
          </div>
          <div class="form-text">
            Password must be at least 8 characters long
          </div>
        </div>
        
        <!-- Submit -->
        <button type="submit" class="btn btn-success w-100 fw-bold py-2">
          Reset Password & Login
        </button>
      </form>
      
      <div class="text-center mt-4 small">
        <a href="/login/" class="fw-semibold">‚Üê Back to Login</a>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap Icons CDN -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css" />

<script>
const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

function showSpinner() {
  document.getElementById('spinner').style.display = 'flex';
}
function hideSpinner() {
  document.getElementById('spinner').style.display = 'none';
}

function showMessage(text, isSuccess = true) {
  const msgBox = document.getElementById('msg-box');
  msgBox.innerHTML = `<div class="alert ${isSuccess ? 'alert-success' : 'alert-danger'} alert-dismissible fade show" role="alert">
    ${text}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>`;
}

// Password toggle
document.addEventListener("DOMContentLoaded", function() {
  const passwordField = document.getElementById('newPassword');
  const togglePwdBtn = document.getElementById('togglePassword');
  if (togglePwdBtn && passwordField) {
    togglePwdBtn.addEventListener("click", function () {
      const type = passwordField.type === "password" ? "text" : "password";
      passwordField.type = type;
      this.innerHTML = `<i class="bi bi-eye${type === 'password' ? '' : '-slash'}"></i>`;
    });
  }
});

// Form submission - SINGLE REQUEST
document.getElementById("resetForm").addEventListener("submit", async function (e) {
  e.preventDefault();
  
  // Client-side validation
  const email = document.getElementById("email").value.trim();
  const newPassword = document.getElementById("newPassword").value;
  
  if (!email || !newPassword) {
    showMessage('Please fill all fields.');
    return;
  }
  
  if (newPassword.length < 8) {
    showMessage('Password must be at least 8 characters.');
    return;
  }
  
  showSpinner();
  document.getElementById('msg-box').innerHTML = '';
  
  try {
    const response = await fetch('', {  // Current URL (forget_password)
      method: "POST",
      headers: {
        "X-CSRFToken": csrfToken,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        action: 'reset_password',
        email: email,
        new_password: newPassword
      })
    });
    
    const data = await response.json();
    hideSpinner();
    
    if (data.success) {
      showMessage(data.message || 'Password reset successful! Logging you in...');
      
      if (data.redirect) {
        setTimeout(() => window.location.href = data.redirect, 1500);
      } else {
        setTimeout(() => window.location.href = '/', 1500);
      }
    } else {
      showMessage(data.message || 'Reset failed. Please try again.');
    }
  } catch (err) {
    hideSpinner();
    showMessage('Network error. Please try again.');
  }
});

// Refresh on back/forward
window.addEventListener('pageshow', function(event) {
  if (event.persisted || (window.performance && window.performance.getEntriesByType('navigation')[0].type === 'back_forward')) {
    window.location.reload();
  }
});
</script>
{% endblock %}
