{% extends "enduser/base.html" %}
{% load static %}

{% block title %}Forget Password | Show_me{% endblock %}

{% block content %}

<div class="container d-flex align-items-center justify-content-center min-vh-100">
    <div class="card shadow-lg rounded-4 p-4" style="max-width: 400px; width: 90%;">
        <h2 class="fw-bold mb-3">Forgot Password</h2>

        <div id="message" class="mb-3 text-center"></div>

        <!-- Email form -->
        <form id="emailForm" autocomplete="off">
            {% csrf_token %}
            <div class="mb-3">
                <input type="email" id="email" class="form-control" placeholder="Enter your email" required />
            </div>
            <button type="submit" class="btn btn-primary w-100">Send OTP</button>
        </form>

        <!-- OTP form -->
        <form id="otpForm" class="d-none" autocomplete="off">
            <div class="mb-3">
                <input type="text" id="otp" class="form-control" placeholder="Enter OTP" required maxlength="6" />
            </div>
            <button type="submit" class="btn btn-primary w-100">Verify OTP</button>
        </form>

        <!-- Reset password form -->
        <form id="resetForm" class="d-none" autocomplete="off">
            <div class="mb-3">
                <input type="password" id="newPassword" class="form-control" placeholder="Enter new password" required minlength="6" />
            </div>
            <button type="submit" class="btn btn-primary w-100">Reset Password</button>
        </form>

    </div>
</div>

<script>
const emailForm = document.getElementById('emailForm')
const otpForm = document.getElementById('otpForm')
const resetForm = document.getElementById('resetForm')
const message = document.getElementById('message')

let currentEmail = ''
let currentOtp = ''

function showMessage(text, success = true) {
    message.innerHTML = `<div class="alert ${success ? 'alert-success' : 'alert-danger'}">${text}</div>`
}

emailForm.addEventListener('submit', async e => {
    e.preventDefault()
    const email = document.getElementById('email').value.trim()
    if (!email) return

    showMessage('Sending OTP...')
    const response = await fetch('', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': 'csrfToken'
        },
        body: JSON.stringify({action: 'send_otp', email})
    })
    const data = await response.json()

    if (data.success) {
        showMessage(data.message)
        currentEmail = email
        emailForm.classList.add('d-none')
        otpForm.classList.remove('d-none')
    } else {
        showMessage(data.message, false)
    }
})

otpForm.addEventListener('submit', async e => {
    e.preventDefault()
    const otp = document.getElementById('otp').value.trim()
    if (!otp) return

    showMessage('Verifying OTP...')
    const response = await fetch('', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': 'csrfToken'
        },
        body: JSON.stringify({action: 'verify_otp', email: currentEmail, otp})
    })
    const data = await response.json()

    if (data.success) {
        showMessage(data.message)
        currentOtp = otp
        otpForm.classList.add('d-none')
        resetForm.classList.remove('d-none')
    } else {
        showMessage(data.message, false)
    }
})

resetForm.addEventListener('submit', async e => {
    e.preventDefault()
    const newPassword = document.getElementById('newPassword').value.trim()
    if (!newPassword) return

    showMessage('Resetting password...')
    const response = await fetch('', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': 'csrfToken'
        },
        body: JSON.stringify({action: 'set_password', email: currentEmail, otp: currentOtp, new_password: newPassword})
    })
    const data = await response.json()

    if (data.success) {
        showMessage(data.message)
        setTimeout(() => {
            window.location.href = '/'  // redirect after successful reset + login
        }, 2000)
    } else {
        showMessage(data.message, false)
    }
})
</script>

{% endblock %}
