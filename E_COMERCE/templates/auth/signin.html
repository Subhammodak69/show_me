{% extends "enduser/base.html" %}
{% load static %}

{% block title %}Sign Up | Show_me{% endblock %}

{% block content %}
<div class="container py-3" style="max-width: 500px; background: white;border-radius: 10px;padding: 20px !important;">
  <h2 class="text-center mb-4">Sign Up</h2>
  <div class="spinner-container" id="spinner" style="display:none;">
  <div class="spinner"></div>
</div>
<style>
.spinner-container {
  display: flex;
  justify-content: center;
  align-items: center;
  position:absolute;
  left: 48%;
  top:48%;
}

.spinner {
  width: 60px;
  height: 60px;
  border: 8px solid #f3f3f3;
  border-top: 8px solid #00BFFF; /* Aqua Blue */
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}
</style>
  <div id="msg-box"></div>

  <form id="signupForm">
    {% csrf_token %}

    <!-- Name Fields -->
    <div class="row" id="name-fields">
      <div class="col-md-6 mb-3">
        <label for="first_name" class="form-label">First Name</label>
        <input type="text" class="form-control" name="first_name" required>
      </div>
      <div class="col-md-6 mb-3">
        <label for="last_name" class="form-label">Last Name</label>
        <input type="text" class="form-control" name="last_name" required>
      </div>
    </div>

    <!-- Email and OTP -->
    <div class="mb-3">
      <label for="email" class="form-label">Email Address</label>
      <input type="email" class="form-control" name="email" id="email" required>
    </div>

    <div class="mb-3" id="otp-section" style="display: none;">
      <label for="otp-input" class="form-label">OTP</label>
      <input type="text" class="form-control" name="otp" id="otp-input">
      <button type="button" class="btn btn-warning w-100 mt-2" onclick="checkOTP()">Verify OTP</button>
    </div>

    <!-- OTP Buttons -->
    <div class="mb-3">
      <button type="button" id="send-btn" class="btn btn-primary w-100" onclick="sendOTP()">Send OTP</button>
      <button type="button" id="resend-btn" class="btn btn-secondary w-100 mt-2" style="display: none;" onclick="resendOTP()">Resend OTP</button>
    </div>

    <!-- Password Field -->
    <div class="mb-3" id="password-section" style="display: none;">
      <label for="password" class="form-label">Password</label>
      <input type="password" class="form-control" name="password" required>
    </div>

    <!-- Submit Button -->
    <div id="submit-section" style="display: none;">
      <button type="submit" class="btn btn-success w-100">Submit</button>
    </div>
  </form>
  <p>Already Have Account ?  <a href="/login/">Log in</a></p>
</div>

<script>
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

  function showElement(id) {
    document.getElementById(id).style.display = 'block';
  }

  function hideElement(id) {
    document.getElementById(id).style.display = 'none';
  }

  async function sendOTP() {
    const email = document.getElementById("email").value;
    if (!email) return alert("Please enter an email address.");
    document.getElementById('spinner').style.display = 'block';
    const res = await fetch("{% url 'send_otp' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": csrfToken,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ email }),
    });

    const data = await res.json();

    if (data.success) {
      document.getElementById('spinner').style.display = 'none';
      hideElement('send-btn');
      showElement('resend-btn');
      showElement('otp-section');
    }
    document.getElementById('spinner').style.display = 'none';

    if (data.redirect) window.location.href = data.redirect;
    document.getElementById('spinner').style.display = 'none';

  }

  async function checkOTP() {
    const email = document.getElementById("email").value;
    const otp = document.getElementById("otp-input").value;

    if (!otp) return alert("Enter OTP");

    // Optional: You can verify OTP on server here if needed

    hideElement('otp-section');
    hideElement('resend-btn');
    hideElement('send-btn');
    hideElement('name-fields');
    document.getElementById("email").parentElement.style.display = 'none';

    showElement('password-section');
    showElement('submit-section');
  }

  function resendOTP() {
    sendOTP();
  }

  document.getElementById("signupForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());

    const res = await fetch("{% url 'sign_up' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": csrfToken,
        "Content-Type": "application/json",
      },
      body: JSON.stringify(data),
    });

    const response = await res.json();
    alert(response.message);
    if (response.success) {
      window.location.href = "/login/";
    }
  });
</script>
{% endblock %}
