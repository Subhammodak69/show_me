{% extends "enduser/base.html" %}
{% load static %}

{% block title %}Sign Up | Show_me{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-center min-vh-100">
  <div class="card shadow border-0 rounded-4 w-100" style="max-width: 420px;">
    <div class="card-body p-4">
      <div class="mb-3 text-center">
        <img src="{% static 'logo/logo.png' %}" alt="Logo" width="100" class="mb-2" />
        <h3 class="fw-bold mb-1">Create Account</h3>
        <p class="text-muted mb-3">Sign up to get started</p>
      </div>
      <!-- Spinner (hidden initially) -->
      <div class="justify-content-center mb-3" id="spinner" style="display: none;">
        <div class="spinner-border text-primary" style="width:2.5rem;height:2.5rem;" role="status"></div>
      </div>
      <!-- Messages -->
      <div id="msg-box" class="mb-2"></div>
      <!-- FORM -->
      <form id="signupForm" class="needs-validation" novalidate autocomplete="on">
        {% csrf_token %}
        <!-- Name fields -->
        <div class="row" id="name-fields">
          <div class="col-md-6 mb-3">
            <div class="form-floating">
              <input type="text" class="form-control" id="first_name" name="first_name" placeholder="First Name" required>
              <label for="first_name">First Name</label>
            </div>
          </div>
          <div class="col-md-6 mb-3">
            <div class="form-floating">
              <input type="text" class="form-control" id="last_name" name="last_name" placeholder="Last Name" required>
              <label for="last_name">Last Name</label>
            </div>
          </div>
        </div>
        <!-- Email -->
        <div class="mb-3" id="email-section">
          <div class="form-floating">
            <input type="email" class="form-control" id="email" name="email" placeholder="Email Address" required>
            <label for="email">Email Address</label>
          </div>
        </div>
        <!-- OTP -->
        <div class="mb-3" id="otp-section" style="display: none;">
          <div class="form-floating mb-2">
            <input type="text" class="form-control" id="otp-input" name="otp" placeholder="OTP">
            <label for="otp-input">OTP</label>
          </div>
          <button type="button" class="btn btn-warning w-100" onclick="checkOTP()">Verify OTP</button>
        </div>
        <!-- OTP Buttons -->
        <div class="mb-3" id="otp-buttons">
          <button type="button" id="send-btn" class="btn btn-primary w-100" onclick="sendOTP()">Send OTP</button>
          <button type="button" id="resend-btn" class="btn btn-outline-secondary w-100 mt-2" style="display: none;" onclick="resendOTP()">Resend OTP</button>
        </div>
        <!-- Password -->
        <div class="mb-3" id="password-section" style="display: none;">
          <div class="form-floating position-relative">
            <input type="password" class="form-control" id="password" name="password" placeholder="Password" required>
            <label for="password">Password</label>
            <button type="button" class="btn btn-sm btn-outline-secondary position-absolute top-50 end-0 translate-middle-y me-2"
              id="togglePassword" style="display:none;" tabindex="-1">
              <i class="bi bi-eye"></i>
            </button>
          </div>
        </div>
        <!-- Submit -->
        <div id="submit-section" style="display: none;">
          <button type="submit" class="btn btn-success w-100 fw-bold py-2">Sign Up</button>
        </div>
      </form>
      <div class="text-center mt-4 small">
        Already have an account? <a href="/login/" class="fw-semibold">Sign in</a>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap Icons CDN for password eye -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css" />

<script>
const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

function showElement(id) {
  document.getElementById(id).style.display = '';
}
function hideElement(id) {
  document.getElementById(id).style.display = 'none';
}
function showSpinner() {
  document.getElementById('spinner').style.display = 'flex';
}
function hideSpinner() {
  document.getElementById('spinner').style.display = 'none';
}

// Password toggle
document.addEventListener("DOMContentLoaded", function() {
  let passwordField = document.getElementById('password');
  let togglePwdBtn = document.getElementById('togglePassword');
  if (togglePwdBtn && passwordField) {
    togglePwdBtn.addEventListener("click", function () {
      let type = passwordField.type === "password" ? "text" : "password";
      passwordField.type = type;
      this.innerHTML = `<i class="bi bi-eye${type === 'password' ? '' : '-slash'}"></i>`;
    });
  }
});

// OTP send
async function sendOTP() {
  const email = document.getElementById("email").value;
  if (!email) {
    document.getElementById('msg-box').innerHTML = '<div class="alert alert-warning">Please enter an email address.</div>';
    return;
  }
  showSpinner();
  document.getElementById('msg-box').innerHTML = '';
  try {
    const res = await fetch("{% url 'send_otp' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": csrfToken,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ email })
    });
    const data = await res.json();
    hideElement('send-btn');
    showElement('resend-btn');
    showElement('otp-section');
    if (data.success) {
      document.getElementById('msg-box').innerHTML = `<div class='alert alert-success'>${data.message || "OTP sent!"}</div>`;
    } else {
      document.getElementById('msg-box').innerHTML = `<div class='alert alert-danger'>${data.message || "Error sending OTP"}</div>`;
    }
    hideSpinner();
    if (data.redirect) window.location.href = data.redirect;
  } catch(err) {
    hideSpinner();
    document.getElementById('msg-box').innerHTML = `<div class='alert alert-danger'>Could not send OTP.</div>`;
  }
}

function resendOTP() {
  sendOTP();
}

async function checkOTP() {
  const otp = document.getElementById("otp-input").value;
  if (!otp) {
    document.getElementById('msg-box').innerHTML = '<div class="alert alert-warning">Enter the OTP.</div>';
    return;
  }
  hideElement('otp-section');
  hideElement('otp-buttons');
  hideElement('name-fields');
  hideElement('email-section');
  showElement('password-section');
  showElement('submit-section');
  if(document.getElementById('togglePassword')) {
    document.getElementById('togglePassword').style.display = '';
  }
}

// Submit
document.getElementById("signupForm").addEventListener("submit", async function (e) {
  e.preventDefault();
  showSpinner();
  document.getElementById('msg-box').innerHTML = '';
  const data = {
    first_name: document.getElementById("first_name") ? document.getElementById("first_name").value : "",
    last_name: document.getElementById("last_name") ? document.getElementById("last_name").value : "",
    email: document.getElementById("email") ? document.getElementById("email").value : "",
    otp: document.getElementById("otp-input") ? document.getElementById("otp-input").value : "",
    password: document.getElementById("password") ? document.getElementById("password").value : ""
  }
  try {
    const res = await fetch("{% url 'sign_up' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": csrfToken,
        "Content-Type": "application/json",
      },
      body: JSON.stringify(data)
    });
    const response = await res.json();
    hideSpinner();
    if (response.success) {
      document.getElementById('msg-box').innerHTML = `<div class="alert alert-success">${response.message || "Sign Up Successful! Redirecting..."}</div>`;
      setTimeout(() => window.location.href = "/login/", 1200);
    } else {
      document.getElementById('msg-box').innerHTML = `<div class="alert alert-danger">${response.message || "Sign Up Failed"}</div>`;
    }
  } catch(err) {
    hideSpinner();
    document.getElementById('msg-box').innerHTML = '<div class="alert alert-danger">Could not sign up at this time.</div>';
  }
});
</script>
{% endblock %}
