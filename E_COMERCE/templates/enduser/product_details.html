{% extends 'enduser/base.html' %}
{% load static %}
{% block title %}{{ product_item_data.product_name }} | Show_me{% endblock %}

{% block content %}
<div class="container" style="height: 100%;">
  {% if product_item_data %}
  <div class="row">
    <!-- Main Product Image + Related Items -->
    <div class="col-md-5">
      <div class="border rounded shadow-sm p-2 mb-3" style="height: 450px;">
        <img src="{{ product_item_data.photo }}" alt="{{ product_item_data.product_name }}" class="img-fluid rounded" style="width: 100%;
    height: 100%;
    object-fit: contain;
    background: antiquewhite;">
      </div>
    </div>

    <!-- Product Info -->
    <div class="col-md-7" style="background: whitesmoke;">

      {% if related_products_data %}
      <div>
        <h6 class="text-muted mb-2">Other Available Items</h6>
        <div class="d-flex flex-wrap gap-2">
          {% for item in related_products_data %}
          <div class="border p-2 text-center" style="width: 100px; cursor: pointer;" onclick="window.location.href='{% url 'product_details' item.id %}'">
            <img src="{{ item.photo }}" class="img-fluid mb-1" style="height: 70px; object-fit: contain;">
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <h3>{{ product_item_data.product_name }}</h3>
      <p class="text-muted">
        {{ product_item_data.product_category_name }} <br>
        {{ product_item_data.product_subcategory_name }} 
      </p>
      <h4 class="text-success">‚Çπ{{ product_item_data.price }}</h4>

      <div class="mb-2">
        ‚≠ê 4.3 | 3,619 ratings & 166 reviews
      </div>

      <p><strong>Size:</strong> {{ product_item_data.display_size }}</p>

      <p>
        <strong>Availability:</strong>
        {% if product_item_data.availibility > 0 %}
          In stock ({{ product_item_data.availibility }} available)
        {% else %}
          <span class="text-danger">Out of stock</span>
        {% endif %}
      </p>

      <p><strong>Color:</strong> {{ product_item_data.display_color }}</p>

      <!-- üëá Updated Buttons with login check -->
      <div class="d-flex gap-3 mt-3">
        <button class="btn btn-warning" 
          onclick="{% if user.is_authenticated %}addToCart({{ product_item_data.id }}, '{{ product_item_data.size }}', '{{ product_item_data.color }}'){% else %}window.location.href='{% url 'log_in' %}'{% endif %}">
          <i class="bi bi-cart-plus"></i> Add to Cart
        </button>

        <button class="btn btn-danger"
          onclick="{% if user.is_authenticated %}window.location.href='{% url 'direct_order' item_id=product_item_data.id %}'{% else %}window.location.href='{% url 'log_in' %}'{% endif %}">
          Buy Now
        </button>
      </div>

      <div class="mt-4">
        <h5>Description</h5>
        <p>{{ product_item_data.product_description }}</p>
      </div>

      <div class="mt-4">
        <h6 class="fw-bold">Available Offers</h6>
        <ul class="list-unstyled">
          {% if product_item_data.offer > 0 %}
          <li class="text-success">The offered amount is rs.{{product_item_data.offer}}</li>
          {% else %}
          <p class="text-danger"> Offer not found yet.</p>
          {% endif %}
        </ul>
      </div>
    </div>
  </div>
  {% else %}
    <h3>Product not found</h3>
  {% endif %}
</div>

<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        const trimmed = cookie.trim();
        if (trimmed.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(trimmed.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function addToCart(productItemId, size, color) {
    const csrftoken = getCookie('csrftoken');

    fetch('/cart/create/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken,
      },
      body: JSON.stringify({
        product_item_id: productItemId,
        size: size,
        color: color,
        quantity: 1
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        window.location.href = "{% url 'user_cart' %}";
      } else {
        alert("Failed to add item to cart: " + data.message);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert("Something went wrong!");
    });
  }
</script>
{% endblock %}
