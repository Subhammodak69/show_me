{% extends 'enduser/base.html' %}
{% load static %}
{% block title %}{{ product_item_data.product_name }} | Show_me{% endblock %}

{% block content %}
<div class="container" style="height: 100%;margin: auto;max-width: 100%;">
  {% if product_item_data %}
  <div class="row justify-content-between">
    <!-- Main Product Image + Related Items -->
    <div class="col-md-5">
      <div class="border rounded shadow-sm p-2 mb-3" style="margin: auto;max-width: 600px;max-height: 100%;">
        <div class="position-relative w-100" style="cursor:pointer;">
          <i class="bi bi-heart wishlist-icon" 
            data-product-id="{{ product_item_data.id }}"
            style="align-items: center; display: flex; justify-content: center; width: 40px; height: 40px; font-size:25px; border-radius: 50%; background: white; color: red; position: absolute; right: 10px; top: 10px; cursor: pointer; z-index: 10; transition: all 0.2s ease;"
            {% if user.is_authenticated %}
                onclick="toggle_wishlist_create_update({{ product_item_data.id }})"
            {% else %}
                onclick="window.location.href='{% url 'log_in' %}'"
            {% endif %}
            title="Add to wishlist"></i>
        </div>
        <!-- UPDATE YOUR MAIN IMAGE - ADD DATA ATTRIBUTES -->
        <img src="{{ product_item_data.photo }}" 
            alt="{{ product_item_data.product_name }}" 
            data-original-src="{{ product_item_data.photo }}" 
            data-original-alt="{{ product_item_data.product_name }}"
            class="img-fluid rounded main-product-image" 
            style="width: 100%; height: 100%; object-fit: cover;">
      </div>
    </div>

    <!-- Product Info -->
    <div class="col-md-7 rounded" style="background: #f5f5f591;padding:20px;height: 100%;">
      {% if related_products_data %}
      <div>
        <h6 class="text-muted mb-2">Other Available Items</h6>
        <div class="row overflow-x-auto flex-nowrap gap-2">
        {% for item in related_products_data %}
          <div class="border p-2 text-center flex-shrink-0 related-item" 
              style="width: 100px; cursor: pointer;"
              data-color="{{ item.display_color|default:'' }}"
              data-size="{{ item.display_size|default:'' }}"
              data-image="{{ item.photo }}">
            <img src="{{ item.photo }}" class="img-fluid mb-1" style="height: 70px; object-fit: contain;">
            <small class="d-block text-muted" style="font-size: 10px;">{{ item.display_color }}</small>
          </div>
        {% endfor %}
        </div>
      </div>
      {% endif %}


      <h3>{{ product_item_data.product_name }}<span class="text-muted" style="font-size:18px;"> ({{product_item_data.brand_name}})</span></h3>
      <p class="text-muted">
        {{ product_item_data.product_category_name }} <br>
        {{ product_item_data.product_subcategory_name }} 
      </p>
      <h4 class="text-success">
        {% if product_item_data.sale_price == product_item_data.price %}
          ₹{{ product_item_data.sale_price }}
        {% else %}
          <span style="text-decoration: line-through; color: #dc3545;">₹{{ product_item_data.price }}</span>  
          ₹{{ product_item_data.sale_price }}
        {% endif %}
      </h4>

      <div class="mb-2">
        ⭐ {{product_item_data.rating}} | {{product_item_data.rating_count}} ratings & reviews
      </div>
      
      <!-- Product variants JSON -->
      <script id="product-variants" type="application/json">{{ product_item_data.product_infos_json|safe }}</script>
            
      <div class="mb-3">
        <strong>Color</strong>
        <select name="color" id="color-select" class="form-control">
          <option value="">Select Color</option>
        </select>
      </div>

      <div class="mb-3">
        <strong>Size</strong>
        <select name="size" id="size-select" class="form-control">
          <option value="">Select Size</option>
        </select>
      </div>
      
      <div id="product-info">
        <p><strong>Availability:</strong> <span id="display-availability">Not Selected yet.</span></p>
      </div>
      
      <div class="d-flex gap-3 mt-3">
        <button class="btn btn-warning" 
                id="addToCartBtn"
                disabled
                onclick="{% if user.is_authenticated %}addToCartDynamic(event){% else %}window.location.href='{% url 'log_in' %}'{% endif %}">
          <i class="bi bi-cart-plus"></i> Add to Cart
        </button>

        <button class="btn btn-danger"
                id="buyNowBtn"
                disabled
                onclick="{% if user.is_authenticated %}buyNowDynamic(event){% else %}window.location.href='{% url 'log_in' %}'{% endif %}">
          Buy Now
        </button>
      </div>
    </div>
  </div>

  <div class="mt-4">
    <h5>Description</h5>
    <p style="font-size:14px">{{ product_item_data.product_description }}</p>
    <p style="font-size:14px">{{ product_item_data.product_subcategory_description }}</p>
    <p style="font-size:14px">{{ product_item_data.product_category_description }}</p>
  </div>

  <div class="mt-4">
    <h6 class="fw-bold">Available Offers</h6>
    <ul class="list-unstyled">
     {% if product_item_data.offer %}
      <li class="text-success" style="font-size: 12px; font-style: italic; font-family: system-ui;">{{product_item_data.offer}}({{product_item_data.offer_description}} up to ₹{{product_item_data.discount}})</li>
     {% else %}
      <p class="text-danger"> Offer not found yet.</p>
     {% endif %}
    </ul>
  </div>
  
  <!-- Ratings & Reviews -->
  <div class="mt-4">
    <div class="d-flex justify-content-between">
      <h4>Reviews</h4>
      {% if user.is_authenticated %}
      <button class="btn btn-primary" onclick="openreviewmodal()">Give your's Reviews</button>
      {% endif %}
    </div>

    <!-- Review Modal -->
    <div class="review-modal" id="reviewModal" style="display:none;">
      <div>
        <form id="reviewForm">
          <input type="hidden" id="product_id" value="{{ product_item_data.product_id }}" />
          
          <div id="starRating">
            <span class="star" data-value="1">&#9733;</span>
            <span class="star" data-value="1">&#9733;</span>
            <span class="star" data-value="1">&#9733;</span>
            <span class="star" data-value="1">&#9733;</span>
            <span class="star" data-value="1">&#9733;</span>
          </div>
          <input type="hidden" id="rating" name="rating" />
          
          <div class="px-2">
            <div class="d-flex justify-content-between" style="position: relative;">
              <textarea id="review" style="border:none; background:rgb(206, 206, 206); padding:10px; width:100%;" placeholder="Write your review" required></textarea>
              <input type="file" id="photoInput" accept="image/*" style="display:none;" />
              <i id="photoIcon" style="right: 10px; bottom: 22%; position: absolute; font-size: 20px; cursor: pointer;" class="bi-card-image"></i>
            </div>
            
            <div id="photoPreviewContainer" style="margin-top: 10px; display:none;">
              <img id="photoPreview" src="" alt="Photo Preview" style="max-width: 100%; max-height: 70px; border-radius: 4px;" />
            </div>
            
            <button class="btn btn-primary mt-2" type="submit">Submit Review</button>
          </div>
        </form>
      </div>
    </div>
    <hr>

    <!-- Reviews List -->
    {% if ratings %}
      <div class="reviews-container space-y-4">
        <div id="reviews-show"></div>
        {% for rating in ratings %}
          <div>
            <div class="d-flex justify-content-between items-center justify-between divhel">
              <div class="d-flex gap-2 font-bold helstar">
                <p style="font-weight: bold; margin:0px!important;">
                  {{ rating.created_by_fullname|default:"Anonymous" }}
                </p>
                <div id="ratingTime" data-timestamp="{{ rating.created_at|date:'c' }}" style="font-size: medium;color: #75716d;">
                </div>
              </div>
              {% for i in rating.rating_range %}
                ⭐
              {% endfor %}
              {% for i in rating.empty_range %}
                ☆
              {% endfor %}
            </div>
            <p class="text-gray-700 mb-2 m-auto" style="width:96%;">{{ rating.review }}</p>
            {% if rating.photo %}
              <img src="{{ rating.photo }}" alt="Review photo" class="max-w-xs rounded-md mb-2 shadow" />
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div id="reviews-show"></div>
        <p id="noReview" class="text-red-600 font-semibold">No reviews found yet.</p>
      </div>
    {% endif %}
  {% else %}
    <h3>Product not found</h3>
  {% endif %}
</div>

<!-- Load external JS -->
<script src="{% static 'js/product_details.js' %}"></script>
<style>
  #starRating {
    font-size: 2rem;
    cursor: pointer;
  }
  .star {
    color: lightgray;
    user-select: none;
    display: inline-block;
    margin-right: 5px;
  }
  .star.selected {
    color: gold;
  }
  @media(max-width:480px){
    .helstar{
        justify-content: space-between;
    }
    .divhel{
      flex-direction: column;
    }
  }
</style>
{% endblock %}
