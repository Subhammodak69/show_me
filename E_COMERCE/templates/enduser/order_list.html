{% extends "enduser/base.html" %}
{% load static %}
{% block title %}My Orders{% endblock %}
{% block extra_js %}
<script src="{% static 'js/order_list.js' %}"></script>
{% endblock %}
{% block content %}
<div class="container-fluid p-0 min-vh-100">
  <!-- Orders List -->
  {% if orders %}
  <div class="container py-4">
    {% for order in orders %}
    <div class="bg-white shadow-sm rounded-3 mb-4 order-card" id="order-{{ order.id }}" data-order-id="{{ order.id }}">
      <!-- Order Header -->
      <div class="p-4 border-bottom">
        <div class="row align-items-center g-3">
          <div class="col-md-8">
            <div class="d-flex align-items-center">
              <span class="badge bg-light text-dark border fw-medium px-3 py-2 me-3 fs-6">
                #{{ order.id }}
              </span>
              {% if order.status == 5 %}
              <span class="badge bg-danger px-3 py-2 fw-medium">{{ order.status_display }}</span>
              {% elif order.status == 4 %}
              <span class="badge bg-success px-3 py-2 fw-medium">{{ order.status_display }}</span>
              {% elif order.status == 3 %}
              <span class="badge bg-warning px-3 py-2 fw-medium text-dark">{{ order.status_display }}</span>
              {% else %}
              <span class="badge bg-info px-3 py-2 fw-medium text-dark">{{ order.status_display }}</span>
              {% endif %}
            </div>
          </div>
          <div class="col-md-4 text-md-end">
            <div class="text-muted small">{{ order.created_at|date:"d M Y" }}</div>
            <div class="h6 mb-0 fw-semibold text-success mt-1">Total ₹{{ order.total_price }}</div>
          </div>
        </div>
      </div>

      <!-- Order Items -->
      <div class="p-4">
        {% if order.items %}
        <div class="row g-3">
          {% for item in order.items %}
          <div class="col-12">
            <div class="row align-items-center g-3 p-3 bg-light rounded-2">
              <div class="col-md-2 col-3">
                <div class="position-relative">
                  <img src="{% if item.product_item.photo_url %}{{ item.product_item.photo_url }}{% else %}{% static 'images/no_image.png' %}{% endif %}"
                       class="rounded-2 w-100 h-100 object-fit-cover shadow-sm" 
                       style="max-height: 100px; max-width: 120px;" 
                       alt="{{ item.product_item.product.name }}">
                </div>
              </div>
              <div class="col-md-7 col-6">
                <p class="mb-2 fw-semibold" style="font-size:12px;">{{ item.product_item.product.name|truncatechars:50 }}</p>
                <div class="text-muted small">
                  <span class="me-2">Qty: {{ item.quantity }}</span>
                  <span class="me-2">Size: {{ item.get_size_display }}</span>
                  <span>Color: {{ item.get_color_display }}</span>
                </div>
              </div>
              <div class="col-md-3 col-3 text-md-end text-start">
                <div class="h6 mb-1 fw-semibold text-dark">₹{{ item.price }}</div>
                <div class="text-muted small">per item</div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
        {% endif %}
      </div>

      <!-- Order Footer -->
      <div class="p-4 pt-0 border-top">
        <div class="row align-items-center g-2">
          <div class="col-md-7">
            <div class="row g-2">
              <div class="col-auto">
                <span class="text-muted small me-1">Deliver to:</span>
                <strong class="text-dark"style="font-size:12px;white-space:nowrap;">{{ order.delivery_address|truncatechars:40 }}</strong>
              </div>
              {% if order.phone %}
              <div class="col-auto">
                <span class="text-muted small">Phone: {{ order.phone }}</span>
              </div>
              {% endif %}
            </div>
          </div>
          <div class="col-md-5 mt-3 text-md-end text-start">
            {% if order.status == 1 or order.status == 2 %}
            <button class="btn btn-outline-danger btn-sm px-4 me-2" onclick="confirmDelete('{{ order.id }}')">
              Cancel Order
            </button>
            {% endif %}
            <a href="{% url 'track_order' order.id %}" class="btn btn-primary btn-sm px-4">
              Track Order
            </a>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="container py-5 text-center">
    <div class="row justify-content-center">
      <div class="col-md-6">
        <div class="text-center py-5">
          <i class="bi bi-bag-check display-1 text-muted mb-4"></i>
          <h4 class="fw-semibold text-muted mb-3">No orders yet</h4>
          <p class="text-muted mb-4">You've not placed any orders yet.</p>
          <a href="/" class="btn btn-primary btn-lg px-4">
            Continue Shopping
          </a>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-danger text-white border-0">
        <h5 class="modal-title fw-semibold mb-0">
          <i class="bi bi-exclamation-triangle me-2"></i>
          Confirm Cancellation
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body py-4">
        <p class="mb-0 text-muted">Are you sure you want to cancel this order? This action cannot be undone.</p>
      </div>
      <div class="modal-footer border-0 pt-0">
        <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">
          Keep Order
        </button>
        <button type="button" class="btn btn-danger px-4" id="confirmDeleteBtn">
          Cancel Order
        </button>
      </div>
    </div>
  </div>
</div>

<style>
.order-card {
  transition: all 0.2s ease;
}
.order-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.1) !important;
}
.object-fit-cover {
  object-fit: cover;
}
@media (max-width: 768px) {
  .order-card .p-4 {
    padding: 1rem !important;
  }
}
</style>
{% endblock %}
