{% extends "enduser/base.html" %}
{% load static %}

{% block title %}Profile{% endblock %}

{% block content %}
<!-- Delivery Address Modal -->
<div class="modal fade" id="deliveryAddressModal" tabindex="-1" aria-labelledby="deliveryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="deliveryModalLabel">
                    <i class="bi bi-geo-alt me-2"></i>Address
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form id="deliveryAddressForm">
                    <div class="row g-3">
                        <!-- State -->
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">State <span class="text-danger">*</span></label>
                            <select class="form-select" id="stateSelect" required>
                                <option value="">Select State</option>
                            </select>
                        </div>
                        <!-- City -->
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">City <span class="text-danger">*</span></label>
                            <select class="form-select" id="citySelect" required disabled>
                                <option value="">Select City</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- PIN Code -->
                    <div class="row g-3 mt-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">PIN Code <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="pinCode" placeholder="110001" required maxlength="6">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Phone <span class="text-danger">*</span></label>
                            <input type="tel" class="form-control" id="phone" placeholder="9876543210" required maxlength="10">
                        </div>
                    </div>
                    
                    <!-- Village/Locality & Road/Landmark -->
                    <div class="row g-3 mt-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Village/Locality <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="locality" placeholder="Enter village/locality" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Road/Street/Landmark <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="road" placeholder="House no, street, landmark" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0 bg-light">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveAddressBtn">
                    <span class="spinner-border spinner-border-sm d-none me-2" id="saveSpinner"></span>
                    Save Address
                </button>
            </div>
        </div>
    </div>
</div>

<div class="container py-5" style="max-width:800px;">
    <!-- Profile Header -->
    <header class="text-center mb-5">
        {% if request.user.profile_photo_url %}
        <img src="{{ request.user.profile_photo_url }}" class="rounded-circle shadow-lg mb-3" 
             style="width: 120px; height: 120px; object-fit: cover;" alt="Profile Photo">
        {% else %}
        <div class="rounded-circle m-auto bg-primary text-white d-flex align-items-center justify-content-center mb-3 shadow-lg" 
            style="width: 60px; height: 60px; font-size: 2rem; font-weight: bold;">
            {{request.user.first_name|default:request.user.username|slice:":1"|upper }}
        </div>
        {% endif %}
        <h3 class="fw-bold text-dark mb-2" id="username">{{request.user.first_name}} {{request.user.last_name}}</h3>
        <p class="text-muted mb-1" id="email">{{request.user.email}}</p>
        <small class="text-success fw-semibold" id="phoneDisplay">{{request.user.phone|default:'No phone added'}}</small>
    </header>

    <!-- Navigation Tabs -->
    <nav class="profile-nav mb-5">
        <ul class="nav nav-pills nav-fill rounded-pill shadow-sm bg-white p-1">
            <li class="nav-item">
                <a href="/profile/" class="nav-link active rounded-pill px-4 py-2" aria-current="page">
                    <i class="bi bi-person-circle me-2"></i>Personal Info
                </a>
            </li>
            <li class="nav-item">
                <a href="/orders/" class="nav-link px-4 py-2 " style="color: #000000!important; ">
                    <i class="bi bi-box-seam me-2"></i>Order History
                </a>
            </li>
        </ul>
    </nav>

    <!-- Personal Info Section -->
    <section class="profile-card bg-white rounded-4 px-5">
        <h2 class="h3 fw-bold mb-4 border-bottom pb-3">Personal Information</h2>
        
        <form class="info-form" method="post">
            {% csrf_token %}
            
            <div class="row g-4">
                <!-- First Name -->
                <div class="col-md-6">
                    <label class="form-label fw-semibold">First Name <span class="text-danger">*</span></label>
                    <input type="text" class="form-control form-control-lg" name="first_name" 
                           value="{{request.user.first_name}}" required>
                </div>
                
                <!-- Last Name -->
                <div class="col-md-6">
                    <label class="form-label fw-semibold">Last Name <span class="text-danger">*</span></label>
                    <input type="text" class="form-control form-control-lg" name="last_name" 
                           value="{{request.user.last_name}}" required>
                </div>
                
                <!-- Email -->
                <div class="col-12">
                    <label class="form-label fw-semibold">Email <span class="text-danger">*</span></label>
                    <input type="email" class="form-control form-control-lg" value="{{request.user.email}}" readonly>
                </div>
                
                <!-- Phone -->
                <div class="col-md-6">
                    <label class="form-label fw-semibold">Phone <span class="text-danger">*</span></label>
                    <input type="tel" class="form-control form-control-lg" name="phone" 
                           value="{{request.user.phone|default:''}}" maxlength="10"
                           pattern="[0-9]{10}" inputmode="numeric" autocomplete="tel" required>
                    <div class="form-text">Enter 10-digit mobile number</div>
                </div>
                
                <!-- Gender -->
                <div class="col-md-6">
                    <label class="form-label fw-semibold">Gender</label>
                    <select class="form-select form-select-lg" name="gender" required>
                        <option value="">--select--</option>
                        {% for gender in gender_options %}
                        <option value="{{gender.value}}" {% if request.user.gender == gender.value %}selected{% endif %}>
                            {{gender.name}}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Address -->
                <div class="col-12">
                    <div class="card border-0 h-100">
                        <div>
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <label class="form-label fw-semibold mb-0">Address <span class="text-danger">*</span></label>
                                <button type="button" class="btn btn-outline-primary btn-sm" id="addAddress">
                                    <i class="bi bi-plus-circle me-1"></i>Add/Edit Address
                                </button>
                            </div>
                            <textarea class="form-control form-control-lg" name="address" id="addressDisplay" 
                                      rows="4" required readonly 
                                      style="resize: vertical; min-height: 100px;">{{request.user.address|default:'No address added. Click "Add/Edit Address" to set your delivery address.'}}</textarea>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="text-end mt-5">
                <button class="btn btn-success btn-lg px-5" type="submit">
                    <i class="bi bi-check-circle me-2"></i>Save Changes
                </button>
            </div>
        </form>
    </section>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = new bootstrap.Modal(document.getElementById('deliveryAddressModal'));
    const form = document.getElementById('deliveryAddressForm');
    const saveBtn = document.getElementById('saveAddressBtn');
    const addAddressBtn = document.getElementById('addAddress');
    const addressDisplay = document.getElementById('addressDisplay');
    const phoneDisplay = document.getElementById('phoneDisplay');
    
    // ðŸ”¥ YOUR initStateCityDropdowns FUNCTION - INTEGRATED
    function initStateCityDropdowns() {
        const states = ['West Bengal', 'Delhi', 'Maharashtra', 'Uttar Pradesh', 'Kerala'];
        const stateSelect = document.getElementById('stateSelect');
        
        states.forEach(state => {
            const option = document.createElement('option');
            option.value = state; 
            option.textContent = state;
            stateSelect.appendChild(option);
        });

        stateSelect.addEventListener('change', function() {
            const citySelect = document.getElementById('citySelect');
            citySelect.innerHTML = '<option value="">Select City</option>';
            citySelect.disabled = false;
            
            const cities = {
                'West Bengal': ['Kolkata', 'Siliguri', 'Durgapur', 'Asansol'],
                'Delhi': ['New Delhi', 'Delhi'],
                'Maharashtra': ['Mumbai', 'Pune', 'Nagpur', 'Nashik'],
                'Uttar Pradesh': ['Lucknow', 'Kanpur', 'Varanasi', 'Agra'],
                'Kerala': ['Kochi', 'Thiruvananthapuram', 'Kozhikode']
            };
            
            if (cities[this.value]) {
                cities[this.value].forEach(city => {
                    const option = document.createElement('option');
                    option.value = city; 
                    option.textContent = city;
                    citySelect.appendChild(option);
                });
            }
        });
    }
    
    // Initialize dropdowns on page load
    initStateCityDropdowns();
    
    // Open modal & prefill
    addAddressBtn.addEventListener('click', () => {
        modal.show();
        // Prefill current data if exists
        if (addressDisplay.value && addressDisplay.value !== 'No address added...') {
            const parts = parseAddress(addressDisplay.value);
            document.getElementById('stateSelect').value = parts.state || '';
            document.getElementById('citySelect').value = parts.city || '';
            document.getElementById('pinCode').value = parts.pin || '';
            document.getElementById('locality').value = parts.locality || '';
            document.getElementById('road').value = parts.road || '';
            document.getElementById('phone').value = parts.phone || '';
        }
    });
    
    // Parse comma-separated address: "State, City, PIN, Locality, Road, Phone"
    function parseAddress(address) {
        const parts = address.split(',');
        return {
            state: parts[0]?.trim() || '',
            city: parts[1]?.trim() || '',
            pin: parts[2]?.trim() || '',
            locality: parts[3]?.trim() || '',
            road: parts[4]?.trim() || '',
            phone: parts[5]?.trim() || ''
        };
    }
    
    // Save address to textarea (comma-separated format)
    saveBtn.addEventListener('click', function() {
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
        
        const spinner = document.getElementById('saveSpinner');
        spinner.classList.remove('d-none');
        saveBtn.disabled = true;
        
        const state = document.getElementById('stateSelect').value;
        const city = document.getElementById('citySelect').value;
        const pin = document.getElementById('pinCode').value;
        const locality = document.getElementById('locality').value;
        const road = document.getElementById('road').value;
        const phone = document.getElementById('phone').value;
        
        // âœ… PERFECT FORMAT: "State, City, PIN, Locality, Road, Phone"
        const fullAddress = `${state}, ${city}, ${pin}, ${locality}, ${road}, ${phone}`.trim();
        
        // Update form fields for submission
        addressDisplay.value = fullAddress;
        phoneDisplay.textContent = phone || 'No phone added';
        document.querySelector('input[name="phone"]').value = phone;
        
        // Reset modal
        spinner.classList.add('d-none');
        saveBtn.disabled = false;
        modal.hide();
        form.reset();
        document.getElementById('citySelect').disabled = true;
        
        showSuccess('âœ… Address saved successfully!');
    });
    
    // Success alert
    window.showSuccess = function(msg) {
        const toast = document.createElement('div');
        toast.className = 'alert alert-success position-fixed top-0 end-0 m-3 shadow-lg';
        toast.style.cssText = 'z-index: 9999; max-width: 350px;';
        toast.innerHTML = `
            <i class="bi bi-check-circle-fill me-2"></i>${msg}
            <button type="button" class="btn-close btn-close-white ms-2" onclick="this.parentElement.remove()"></button>
        `;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
    };
});
</script>


<style>
.profile-card {
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.2);
}

.nav-pills .nav-link.active {
    background: linear-gradient(45deg, #21d6f9, #007bff) !important;
    color: white !important;
}

.form-control:focus {
    border-color: #21d6f9;
    box-shadow: 0 0 0 0.2rem rgba(33, 214, 249, 0.25);
}

@media (max-width: 768px) {
    .container { padding: 20px 15px; }
    .profile-card { margin: 0 -15px; border-radius: 0; padding: 0px 30px !important; }
}
@media(max-width:480px){
    input.form-control{
        font-size: 12px!important;
    }
    .form-label{
        font-size: 12px;
    }
    .form-select{
        font-size: 12px;
    }
}
</style>
{% endblock %}
