{% extends "enduser/base.html" %}
{% load static %}

{% block title %}Cart | Show_me{% endblock %}
{% block extra_js %}
  <script src="{% static 'js/order_summary.js' %}"></script>
{% endblock %}
{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/order_summary.css' %}">
{% endblock %}

{% block content %}
<!--modal-->
<div class="modal fade" id="deliveryAddressModal" tabindex="-1" aria-labelledby="deliveryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deliveryModalLabel">Delivery Address</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="deliveryAddressForm">
          <div class="row">
            <!-- State -->
            <div class="col-md-6 mb-3">
              <label class="form-label">State <span class="text-danger">*</span></label>
              <select class="form-select" id="stateSelect" required>
                <option value="">Select State</option>
              </select>
            </div>
            <!-- City -->
            <div class="col-md-6 mb-3">
              <label class="form-label">City <span class="text-danger">*</span></label>
              <select class="form-select" id="citySelect" required disabled>
                <option value="">Select City</option>
              </select>
            </div>
          </div>
          <!-- PIN Code -->
          <div class="col-12 mb-3">
            <label class="form-label">PIN Code <span class="text-danger">*</span></label>
            <input type="number" class="form-control" id="pinCode" placeholder="110001" required maxlength="6">
          </div>
          <!-- Village/Locality -->
          <div class="col-12 mb-3">
            <label class="form-label">Village/Locality <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="locality" placeholder="Enter village/locality" required>
          </div>
          <!-- Road/Landmark -->
          <div class="col-12 mb-3">
            <label class="form-label">Road/Street/Landmark <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="road" placeholder="House no, street, landmark" required>
          </div>
          <!-- Phone Number -->
          <div class="col-12 mb-3">
            <label class="form-label">Phone Number <span class="text-danger">*</span></label>
            <input type="tel" class="form-control" id="phoneNumber" placeholder="98XXXXXXXX" required maxlength="10">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary" id="saveAddressBtn">
          <span class="spinner-border spinner-border-sm d-none" id="saveSpinner"></span>
          Placed Order
        </button>
      </div>
    </div>
  </div>
</div>
<!--modal end-->

<div class="container-fluid" style="height: 100%;padding:0px !important; margin-bottom: 20px;">
  <h2 class="mb-3 text-center fw-bold">Your Order Summary</h2>

  <form id="order-form" method="POST" class="d-flex flex-column flex-md-row justify-content-center align-items-stretch gap-4"
    style="background: white; border-radius: 12px; padding: 1.5rem 0.5rem;">
    <!-- Cart Items - UPDATED with dynamic variants -->
    <div id="cart-items" class="w-100 w-md-50"style="max-width:400px;overflow: auto;max-height: 80vh;max-width: 400px;scrollbar-width:thin;">
      {% for item in cart_items %}
      <!-- Remove Button -->
          <div style="position: relative;width: 100%;">
            <i class="bi bi-x" onclick="removeItem({{ item.id }})" style=" height: 30px;width: 30px;display: flex;align-items: center;justify-content: center;top: 10px;right: 10px;position: absolute;color: red;font-size: 25px;background: aliceblue;border-radius: 50%;"></i>
          </div>
      <!-- Add these data attributes to each cart-item div -->
      <div class="cart-item border p-5 rounded text-center mb-3" 
          data-id="{{ item.id }}"
          data-size-display="{{ item.size_display }}"
          data-color-display="{{ item.color_display }}">
         
        <!-- Product Image - DYNAMIC -->
        <div class="mb-3">
          <img id="product-image-{{ item.id }}" 
              src="{{ item.photo }}" 
              class="rounded" 
              alt="Product Image" 
              style="width: 100%; max-width: 135px; height: 140px; object-fit: contain;">
        </div>
        
        <!-- Product Info -->
        <p class="fw-semibold mb-2" style="width: 100%; font-size:20px;text-overflow: ellipsis;white-space: nowrap;overflow: hidden;">{{ item.product_name }}</p>
        
        <!-- Variant JSON Data -->
        <script id="variants-{{ item.id }}" type="application/json">{{ item.all_variants_json|safe }}</script>
        
        <!-- Current Variant Info -->
        <div id="availability-{{ item.id }}" class="mb-2">
          <strong>Availability:</strong> 
          <span id="display-availability-{{ item.id }}" class="badge bg-secondary">
            Loading...
          </span>
        </div>
        
        <!-- Selectors -->
        <div class="d-flex flex-wrap gap-2 justify-content-center mb-2" style="margin: auto;max-width: 250px; flex-direction: column; width: 100%;">
          <!-- Quantity -->
          <div class="d-flex align-items-center justify-content-center gap-4 w-100">
            <label>Quantity:</label>
            <input type="number" 
                  id="quantity-{{ item.id }}" 
                  name="quantity" 
                  value="{{ item.quantity }}" 
                  min="1"
                  required 
                  class="form-control w-50 mx-auto" style="font-size:12px;">
          </div>
          
          <!-- Color -->
          <div class="d-flex align-items-center justify-content-center gap-4 w-100">
            <label class="d-block">Color:</label>
            <select id="color-{{ item.id }}" class="form-select text-center w-100"style="font-size:12px;">
              <option value="">Select Color</option>
            </select>
          </div>
          <!-- Size -->
          <div class="d-flex align-items-center justify-content-center gap-4 w-100">
            <label class="d-block">Size:</label>
            <select id="size-{{ item.id }}" class="form-select text-center w-100"style="font-size:12px;">
              <option value="">Select Size</option>
            </select>
          </div>

          
        </div>
      </div>
      {% endfor %}
    </div>

    <div class="w-100 w-md-50 d-flex flex-column justify-content-between mt-0" style="max-width:600px;">
      <div class="border rounded p-3 mb-3 bg-light">
        <h4>Payable Amount</h4>
        <div class="d-flex align-items-center w-100 justify-content-between">
          <div>Product item-- </div>
          <div class="text-secondary" id="summary-price">{{price|floatformat:2}}</div>  <!-- ✅ Added ID -->
        </div>
        <div class="d-flex align-items-center w-100 justify-content-between">
          <div>Discount Amount-- </div>
          <div class="text-danger" id="summary-discount">-{{discount}}</div>          <!-- ✅ Added ID -->
        </div>
        <br>
        <hr>
        <div class="d-flex align-items-center w-100 justify-content-between">
          <div>Total-- </div>
          <div class="text-success" id="summary-total">{{total|floatformat:2}}</div>  <!-- ✅ Added ID -->
        </div>
      </div>

    
      <div class="border rounded p-3 mb-3 bg-light">
        <h4 class="mb-3">User Details</h4>
        <p><strong>Full Name:</strong> {{ user.get_full_name }}</p>
        <p><strong>Email:</strong> {{ user.email }}</p>
        {% if user.address %}
        <p><strong>Address:</strong> {{ user.address }}</p>
        {% endif %}
      </div>
      
      <label>Select Payment Options</label>
        <select id="paymentSelect" name="select" class="form-control" required>
          <option value="">--Select--</option>
          <option value="cod">Cash On Delivery</option>
        </select>
      <button id="orderBtn" type="button" class="btn btn-success d-block mt-4" disabled>Proceed</button>
    </div>
  </form>
</div>
{% endblock %}
