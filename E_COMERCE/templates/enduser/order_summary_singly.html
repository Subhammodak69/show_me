{% extends "enduser/base.html" %}
{% load static %}

{% block title %}Order | Show_me{% endblock %}
{% block extra_js %}
  <script src="{% static 'js/order_summary_singly.js' %}"></script>
  <script src="{% static 'js/review.js' %}"></script>
  <script src="{% static 'js/single_summary_update.js' %}"></script>
  <script src="{% static 'js/variant_select.js' %}"></script>
  <script src="{% static 'js/delivery_form.js' %}"></script>
{% endblock %}
{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/order_summary_singly.css' %}">
{% endblock %}
{% block content %}
<!-- Delivery Address Modal -->
<div class="modal fade" id="deliveryAddressModal" tabindex="-1" aria-labelledby="deliveryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deliveryModalLabel">Delivery Address</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="deliveryAddressForm">
         <div class="row">
           <!-- State -->
           <div class="col-md-6 mb-3">
             <label class="form-label">State <span class="text-danger">*</span></label>
             <select class="form-select" id="stateSelect" required>
               <option value="">Select State</option>
             </select>
           </div>
           <!-- City -->
           <div class="col-md-6 mb-3">
             <label class="form-label">City <span class="text-danger">*</span></label>
             <select class="form-select" id="citySelect" required disabled>
               <option value="">Select City</option>
             </select>
           </div>
         </div>
         <!-- PIN Code -->
         <div class="col-12 mb-3">
           <label class="form-label">PIN Code <span class="text-danger">*</span></label>
           <input type="number" class="form-control" id="pinCode" placeholder="110001" required maxlength="6">
         </div>
         <!-- Village/Locality -->
         <div class="col-12 mb-3">
           <label class="form-label">Village/Locality <span class="text-danger">*</span></label>
           <input type="text" class="form-control" id="locality" placeholder="Enter village/locality" required>
         </div>
         <!-- Road/Landmark -->
         <div class="col-12 mb-3">
           <label class="form-label">Road/Street/Landmark <span class="text-danger">*</span></label>
           <input type="text" class="form-control" id="road" placeholder="House no, street, landmark" required>
         </div>
         <!-- Phone Number -->
         <div class="col-12 mb-3">
           <label class="form-label">Phone Number <span class="text-danger">*</span></label>
           <input type="tel" class="form-control" id="phoneNumber" placeholder="98XXXXXXXX" required maxlength="10">
         </div>
       </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveAddressBtn">
          <span class="spinner-border spinner-border-sm d-none" id="saveSpinner"></span>
          Place Order
        </button>
      </div>
    </div>
  </div>
</div>

<div class="container-fluid" style="height: 100%; margin-bottom: 20px; padding: 0px !important;max-width: 1000px !important;">
  <h2 class="mb-3 text-center fw-bold">Your Order Summary</h2>

  <!-- ðŸ”¥ FIXED FORM - method="POST" + CSRF -->
  <form id="direct-order-form" method="POST" action="" class="d-flex flex-column flex-md-row justify-content-between align-items-stretch gap-4"
    style="background: white; border-radius: 12px; padding: 1.5rem 0.5rem;">
    {% csrf_token %}
    
    <!-- Product Item -->
    <div class="w-100 cart-item p-3 text-center w-md-50 mb-3 mb-md-0 d-flex flex-column align-items-center">
      <img src="{{ item_data.product_photo }}"
           id="product-image"
           class="mb-3 rounded" alt="Product Image"
           style="width: 100%; max-width: 170px; height: auto;">

      <h5 class="fw-semibold mb-3">{{ item_data.product_name }}</h5>
      
      <!-- Variant JSON Data -->
      <script id="variants-data" type="application/json">
        {{ item_data.variants_json|safe }}
      </script>
      
      <!-- Availability -->
      <div id="availability" class="mb-2">
        <strong>Availability:</strong> 
        <span id="display-availability" class="badge bg-secondary">Loading...</span>
      </div>

      <div class="d-flex flex-column justify-content-center gap-3 flex-wrap mt-2" style="width: 100%; max-width: 250px;">
        <!-- Quantity ðŸ”¥ UPDATED WITH MAX ATTRIBUTE -->
        <div class="d-flex gap-4">
         <label class="d-block">Quantity:</label>
         <input type="number" id="quantity" class="form-control w-100 text-center" 
                value="{{ item_data.quantity|default:'1' }}" min="1" max="999">
        </div>

         <!-- Color -->
        {% if item_data.color_options %}
        <div class="d-flex gap-4">
         <label class="d-block">Color:</label>
         <select id="color" class="form-select text-center w-100" data-initial-color="{{ item_data.color }}">
           <option value="">Select Color</option>
           {% for c in item_data.color_options %}
             <option value="{{ c.value }}" data-display="{{ c.name }}" 
                     {% if c.value == item_data.color %}selected{% endif %}>
               {{ c.name }}
             </option>
           {% endfor %}
         </select>
        </div>
        {% endif %}

        <!-- Size -->
        <div class="d-flex gap-4">
         <label class="d-block">Size:</label>
         <select id="size" class="form-select text-center w-100" data-initial-size="{{ item_data.size }}">
           <option value="">Select Size</option>
           {% for s in item_data.size_options %}
             <option value="{{ s.value }}" data-display="{{ s.name }}" 
                     {% if s.value == item_data.size %}selected{% endif %}>
               {{ s.name }}
             </option>
           {% endfor %}
         </select>
        </div>

      </div>
    </div>
    
    <!-- ðŸ”¥ FIXED: Correct product_item value -->
    <input type="hidden" name="product_item_id" value="{{ item_data.product_item }}" id="product_item_id">

    <div id="pay-de" style="width:55%;">
      <!-- Summary -->
      <div class="border rounded mb-3">
        <h4 class="p-3 bg-primary text-light">Payable Amount</h4>
        <div class="p-3">
         <div class="d-flex align-items-center w-100 justify-content-between">
           <div>Product item-- </div>
           <div class="text-secondary" id="summary-price">{{ item_data.price|floatformat:2 }}</div>
         </div>
         <div class="d-flex align-items-center w-100 justify-content-between">
           <div>Discount Amount-- </div>
           <div class="text-danger" id="summary-discount">-{{ item_data.discount|floatformat:2 }}</div>
         </div>
         <br>
         <hr>
         <div class="d-flex align-items-center w-100 justify-content-between">
           <div>Total-- </div>
           <div class="text-success" id="summary-total">{{ item_data.total_price|floatformat:2 }}</div>
         </div>
        </div>
      </div>

      <!-- User Details -->
      <div class="border rounded p-3 mb-3 bg-light">
        <h4 class="mb-3">User Details</h4>
        <p><strong>Full Name:</strong> {{ user.get_full_name }}</p>
        <p><strong>Email:</strong> {{ user.email }}</p>
        {% if user.address %}
        <p><strong>Address:</strong> {{ user.address }}</p>
        {% endif %}
      </div>
      
      <label>Select Payment Options</label>
      <select id="paymentSelect" class="form-control mb-3" required>
        <option value="">--Select--</option>
        <option value="cod">Cash On Delivery</option>
      </select>
      <button type="button" id="orderBtn" class="btn btn-success d-block mt-4" disabled>Proceed</button>
    </div>
  </form>
</div>

{% endblock %}