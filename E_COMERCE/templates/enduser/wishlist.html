{% extends "enduser/base.html" %}
{% load static %}

{% block title %}My Wishlist{% endblock %}

{% block content %}
<div class="container-fluid my-5">
  <div class="row justify-content-center">
    <!-- Sidebar -->
    <div class="col-md-3 mb-4">
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-body text-center py-4">
          {% if user.profile_photo_url %}
            <img src="{{ user.profile_photo_url.url }}" width="64" height="64" class="mb-3 bg-light rounded-circle border" alt="User avatar">
          {% else %}
            <img src="{% static 'logo\user_logo.jpg' %}" width="64" height="64" class="mb-3 bg-light rounded-circle border" alt="Default avatar">
          {% endif %}

          <div class="fw-bold fs-5 mb-1">Hello,<br>{{ user.get_full_name }}</div>
        </div>
      </div>
      <div class="list-group shadow-sm">
        <div class="list-group-item bg-light fw-semibold">
          <i class="bi bi-bag-check-fill me-2 text-primary"></i> MY ORDERS
          <span class="float-end">&gt;</span>
        </div>
        <div class="list-group-item bg-light fw-semibold">
          <i class="bi bi-person-fill me-2 text-primary"></i> ACCOUNT SETTINGS
        </div>
        <div class="list-group-item bg-light fw-semibold">
          <i class="bi bi-credit-card-2-back-fill me-2 text-primary"></i> PAYMENTS
        </div>
      </div>
    </div>

    <!-- Wishlist Main Content -->
    <div class="col-md-9">
      <div class="bg-white rounded-3 shadow-sm p-3 mb-4">
        <h4 class="fw-semibold mb-0">My Wishlist <span class="text-muted fs-6">({{ wishlist_items_data|length }})</span></h4>
      </div>
      {% if wishlist_items_data %}
        <div class="list-group list-group-flush">
          {% for item in wishlist_items_data %}
            <div class="list-group-item py-3 d-flex align-items-center" data-item-id="{{ item.wishlist_id }}" style="border-bottom: 1px solid #ececec; gap: 1.25rem; min-height: 100px;">
              <!-- Image -->
              <div class="flex-shrink-0" style="width:64px;">
                <a href="{% url 'product_details' item.id %}">
                  <img src="{{ item.photo }}" alt="{{ item.name }}" class="img-fluid" style="width:60px; height:60px; object-fit:contain;">
                </a>
                {% if item.availibility == 0 %}
                  <div class="text-danger small mt-1 text-center fw-semibold">Currently unavailable</div>
                {% endif %}
              </div>
              <!-- Details -->
              <div class="flex-grow-1">
                <div>
                  <a href="{% url 'product_details' item.id %}" class="fw-semibold text-decoration-none fs-6" style="color:#1976d2;">{{ item.name }}</a>
                  {% if item.assured %}
                    <span class="ms-2" style="color:#2874f0; font-size:0.93em;">
                      <i class="bi bi-shield-fill-check"></i> Assured
                    </span>
                  {% endif %}
                </div>
                <div class="small mt-1 text-muted">{{ item.description|truncatewords:17 }}</div>
                <div class="my-1">
                  <span class="badge bg-light text-dark border me-2">{{ item.size }}</span>
                  <span class="badge bg-light text-dark border">{{ item.color }}</span>
                </div>
                <div class="mt-2">
                  <span class="fs-5 fw-bold text-dark">₹{{ item.price }}</span>
                  {% if item.original_price and item.original_price > item.price %}
                    <span class="text-muted text-decoration-line-through ms-2">₹{{ item.original_price }}</span>
                    {% if item.discount_percentage %}
                      <span class="text-success fw-semibold ms-2">{{ item.discount_percentage }}% off</span>
                    {% endif %}
                  {% endif %}
                </div>
              </div>
              <!-- Action -->
              <div class="ms-3">
                <button class="btn btn-link text-secondary px-2" onclick="delete_wishlist({{ item.wishlist_id }})" title="Remove">
                  <i class="bi bi-trash" style="font-size:1.3rem;"></i>
                </button>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="alert alert-warning text-center mt-5 py-5 rounded-3 shadow-sm">
          <i class="bi bi-heartbreak fs-1 text-danger mb-3"></i>
          <h4 class="fw-semibold mb-2">Your wishlist is empty</h4>
          <p class="mb-0">Start adding products you love!</p>
          <a href="{% url 'home' %}" class="btn btn-primary mt-3 px-4">Shop Now</a>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
  function delete_wishlist(wishlist_id) {
    fetch("{% url 'wishlist_delete' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrftoken")
      },
      body: JSON.stringify({ wishlist_id: wishlist_id })
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const itemRow = document.querySelector(`[data-item-id="${wishlist_id}"]`);
          if (itemRow) itemRow.remove();
        } else {
          alert(data.error || "Failed to remove from wishlist.");
        }
      })
      .catch(() => alert("Server error."));
  }
  function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
  }
</script>
{% endblock %}
