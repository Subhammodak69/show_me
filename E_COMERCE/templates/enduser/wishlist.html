{% extends "enduser/base.html" %}
{% load static %}

{% block title %}My Wishlist{% endblock %}

{% block content %}
<div class="container my-5"style="padding:10px !important;height: 100%;">

  <div class="row justify-content-between">
    <!-- Sidebar -->
    <div class="col-md-4 mb-4">
      <div class="card shadow border-0 mb-4">
        <div class="card-body text-center py-4">
          {% if user.profile_photo_url %}
            <img src="{{ user.profile_photo_url }}" id="pro-pic" class="rounded-circle" width="40"
              height="40" style="object-fit: cover" alt="User profile photo" />
            {% else %}
            <div id="pro-pic" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin: auto; display: flex; justify-content: center; align-items: center; font-size: 35px;" class="avatar-circle mb-3" aria-label="User initial avatar" role="img">
              {{user.first_name|default:user.username|slice:":1"|upper }}</div>
          {% endif %}

          <div class="fw-bold fs-5 mb-1">Hello,<br>{{ user.get_full_name }}</div>
        </div>
      </div>
      <div class="list-group">
        
        <div class="list-group-item bg-light fw-semibold">
          <i class="bi bi-person-fill me-2 text-primary"></i> My Profile
        </div>

        <div class="list-group-item bg-light fw-semibold" onclick="window.location.href='/orders/'">
          <i class="bi bi-bag-check-fill me-2 text-primary"></i> MY ORDERS
          <span class="float-end">&gt;</span>
        </div>
        <div class="list-group-item bg-light fw-semibold">
          <i class="bi bi-cart-fill me-2 text-primary"></i> My Cart
        </div>
        <div class="list-group-item bg-light fw-semibold">
          <i class="bi bi-person-fill me-2 text-primary"></i> ACCOUNT SETTINGS
        </div>
        <div class="list-group-item bg-light fw-semibold">
          <i class="bi bi-credit-card-2-back-fill me-2 text-primary"></i> PAYMENTS
        </div>
      </div>
    </div>

    <!-- Wishlist Main Content -->
    <div class="col-md-7">
      <div class="bg-white rounded-3 shadow-sm p-3 mb-4">
        <h4 class="fw-semibold mb-0">My Wishlist <span class="text-muted fs-6">({{ wishlist_items_data|length }})</span></h4>
      </div>
      {% if wishlist_items_data %}
        <div class="list-group list-group-flush">
          {% for item in wishlist_items_data %}
            <div class="list-group-item py-3 d-flex align-items-center" data-item-id="{{ item.wishlist_id }}" style="border-bottom: 1px solid #ececec; gap: 1.25rem; min-height: 100px;">
              <!-- Image -->
              <div class="flex-shrink-0" style="width: 100px; justify-content: center; display: flex; flex-direction: column; align-items: center;">
                <a href="{% url 'product_details' item.id %}">
                  <img src="{{ item.photo }}" alt="{{ item.name }}" class="img-fluid" style="width:60px; height:60px; object-fit:contain;">
                </a>
                {% if item.availibility <= 5 %}
                  <div class="text-danger small mt-1 text-center fw-semibold">Harry!({{item.availibility}} stocks available)</div>
                {% endif %}
              </div>
              <!-- Details -->
              <div class="flex-grow-1">
                <div>
                  <a href="{% url 'product_details' item.id %}" class="fw-semibold text-decoration-none fs-6" style="color:#1976d2;">{{ item.name }}</a>
                  {% if item.assured %}
                    <span class="ms-2" style="color:#2874f0; font-size:0.93em;">
                      <i class="bi bi-shield-fill-check"></i> Assured
                    </span>
                  {% endif %}
                </div>
                <div class="small mt-1 text-muted">{{ item.description|truncatewords:17 }}</div>
                <div class="my-1">
                  <span class="badge bg-light text-dark border me-2">{{ item.display_size }}</span>
                  <span class="badge bg-light text-dark border">{{ item.display_color }}</span>
                </div>
                <div class="mt-2">
                  <span class="fs-5 fw-bold text-dark">₹{{ item.price }}</span>
                  {% if item.original_price and item.original_price > item.price %}
                    <span class="text-muted text-decoration-line-through ms-2">₹{{ item.original_price }}</span>
                    {% if item.discount_percentage %}
                      <span class="text-success fw-semibold ms-2">{{ item.discount_percentage }}% off</span>
                    {% endif %}
                  {% endif %}
                </div>
              </div>
              <!-- Action -->
              <div class="ms-3">
                <button class="btn btn-link text-secondary px-2" onclick="delete_wishlist({{ item.wishlist_id }})" title="Remove">
                  <i class="bi bi-trash" style="font-size:1.3rem;"></i>
                </button>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="alert alert-warning text-center mt-5 py-5 rounded-3 shadow-sm">
          <i class="bi bi-heartbreak fs-1 text-danger mb-3"></i>
          <h4 class="fw-semibold mb-2">Your wishlist is empty</h4>
          <p class="mb-0">Start adding products you love!</p>
          <a href="{% url 'home' %}" class="btn btn-primary mt-3 px-4">Shop Now</a>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
  function delete_wishlist(wishlist_id) {
    fetch("{% url 'wishlist_delete' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrftoken")
      },
      body: JSON.stringify({ wishlist_id: wishlist_id })
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const itemRow = document.querySelector(`[data-item-id="${wishlist_id}"]`);
          if (itemRow) itemRow.remove();
        } else {
          alert(data.error || "Failed to remove from wishlist.");
        }
      })
      .catch(() => alert("Server error."));
  }
  function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
  }
</script>
{% endblock %}
