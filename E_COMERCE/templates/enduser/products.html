{% extends "enduser/base.html" %}
{% load static %}

{% block title %}Home | Show_me{% endblock %}

{% block content %}
<div class="home-container" style="gap: 20px;display: flex;">
  <section class="d-flex flex-column" style="width: 100%; overflow-y: auto; gap:10px;">
    {% if product_items %}
    <div class="d-flex flex-wrap gap-5 justify-content-center overflow-auto pb-3" 
         style="min-height: 280px;">
        {% for product in product_items %}
            <div class="card p-2 text-center position-relative flex-shrink-0" 
                 style="min-width:170px;max-width:180px;height:300px;">
                <!-- Wishlist Heart Icon -->
                <i id="wishlist-icon-{{ product.id }}" 
                class="bi bi-heart position-absolute top-0 end-0 m-2 p-1 wishlist-icon"
                style="font-size: 18px; z-index: 10; cursor: pointer;"
                onclick="toggle_wishlist_create_update({{ product.id }})"
                title="Add to wishlist"></i>
                <div class="d-flex align-items-center justify-content-center"style="height: 150px;">
                  <img src="{{ product.photo_url }}" alt="{{ product.title }}" class="card-img-top mx-auto"
                    style="height:100%;object-fit:contain;">
                </div>
                
                <div class="card-body px-0">
                    <div class="text-muted" style="font-size:14px;">⭐{{ product.rating }} | ({{product.rating_count}})</div>

                    <div class="card-title" 
                      style="
                          display: -webkit-box;
                          -webkit-line-clamp: 3;
                          -webkit-box-orient: vertical;
                          overflow: hidden;
                          text-overflow: ellipsis;
                          max-height: 60px;
                          font-size:15px; 
                          color: blue; 
                          cursor:pointer;
                          line-height: 1.3em;
                      "
                      onclick="window.location.href='{% url 'product_details' product.id %}'">
                      {{ product.product_name }}
                  </div>
                  {% if product.price_data.sale_price == product.price_data.original_price  %}
                    <div class="card-text text-muted" style="font-size:14px;">Price ₹{{ product.price_data.original_price }}</div>
                  {% else %}
                  <span style="text-decoration: line-through;font-size:14px; color: #dc3545;">Price ₹{{ product.price_data.original_price }}</span>  
                    <span style="font-size:14px;">₹{{ product.price_data.sale_price }}</span>
                  {% endif %}
                </div>
            </div>
        {% endfor %}
    </div>
    {% else %}
    <p class="text-center muted">Product items not available yet.</p>
    {% endif %}
</section>

</div>

<style>
/* Wishlist icon styles */
.wishlist-icon {
    transition: all 0.3s ease;
}

.wishlist-icon:hover {
    opacity: 1;
    transform: scale(1.1);
}

@keyframes wishlist-bounce {
    0% { transform: scale(1); }
    50% { transform: scale(1.3); }
    100% { transform: scale(1); }
}

.wishlist-bounce {
    animation: wishlist-bounce 0.5s ease-in-out;
}
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadWishlistProducts();
});

async function loadWishlistProducts() {
    try {
        // Fetch user's wishlist from your existing API endpoint
        const response = await fetch('/api/is-liked-status-check/', {  // Update with your actual URL
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'same-origin'
        });

        if (!response.ok) {
            console.log('No wishlist items or user not logged in');
            return;
        }

        const wishlistData = await response.json();
        // Backend returns product_item_id, frontend uses product.id
        const wishlistProductItemIds = wishlistData.map(item => item.product_item_id);

        // Update heart icons for wishlist products
        wishlistProductItemIds.forEach(productItemId => {
            const wishlistIcon = document.getElementById(`wishlist-icon-${productItemId}`);
            if (wishlistIcon) {
                wishlistIcon.classList.remove('bi-heart');
                wishlistIcon.classList.add('bi-heart-fill');
                wishlistIcon.style.color = '#ff4757';
                wishlistIcon.title = 'Remove from wishlist';
            }
        });

    } catch (error) {
        console.error('Error loading wishlist:', error);
    }
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}


function toggle_wishlist_create_update(item_id) {
    const isAuthenticated = "{{ request.user.is_authenticated|yesno:'true,false' }}" === "true";
    if (!isAuthenticated) {
        window.location.href = "{% url 'log_in' %}";
        return;
    }
    fetch("{% url 'wishlist_create_update' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken")
        },
        body: JSON.stringify({ item_id })
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === 'redirect' && data.login_url) {
            window.location.href = data.login_url;
            return;
        }
        const icon = document.querySelector(`#wishlist-icon-${item_id}`);
        if (icon) {
            if (data.status === 'added') {
                icon.className = "bi bi-heart-fill text-danger wishlist-bounce position-absolute top-0 end-0 m-2 p-1 wishlist-icon";
                setTimeout(() => icon.classList.remove("wishlist-bounce"), 500);
            } else if (data.status === 'removed') {
                icon.className = "bi bi-heart position-absolute top-0 end-0 m-2 p-1 wishlist-icon";
            }
        }
    });
}

function getCookie(name) {
    let cookieValue = null;
    document.cookie.split(';').forEach(cookie => {
        cookie = cookie.trim();
        if (cookie.startsWith(name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        }
    });
    return cookieValue;
}
</script>

<style>
  .home-container {
    width: 100%;
    padding: 5px 20px;
  }

  /* Category Header */
  .category-header h3 {
    font-weight: 700;
    font-size: 1.2rem;
  }

  .category-divider {
    border-top: 2px solid #ddd;
    width: 70px;
    margin: 0.2rem 0 0.8rem;
    opacity: 0.6;
  }

  /* Product row now behaves like a grid */
  .product-row {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
  }

  /* Product Card */
  .product-card {
    background: #fff;
    border-radius: 14px;
    box-shadow: 0 4px 20px rgba(95, 180, 230, 0.13);
    display: flex;
    flex-direction: column;
    position: relative;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  /* Hover effect */
  .product-card:hover {
    box-shadow: 0 10px 28px rgba(90, 140, 210, 0.18);
    transform: translateY(-2px);
  }

  /* Image container */
  .product_img {
    height: 200px;
    background: linear-gradient(90deg, #edf3fb 30%, #fff 100%);
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
  }

  .img-pro {
    max-width: 95%;
    max-height: 95%;
    object-fit: contain;
    transition: transform 0.25s ease;
  }

  .product-card:hover .img-pro {
    transform: scale(1.08);
  }

  /* Info area */
  .product-info {
    padding: 0.5rem 0.9rem;
    font-size: 13.6px;
  }

  .product-title {
    font-weight: 600;
    font-size: 1rem;
    margin-bottom: 2px;
  }

  .price {
    color: #2c82f8;
    font-weight: 600;
    font-size: 1.1rem;
  }

  /* Wishlist */
  .wishlist-icon {
    position: absolute;
    top: 8px;
    right: 8px;
    font-size: 1.4rem;
    background: rgba(255, 255, 255, 0.95);
    padding: 5px;
    border-radius: 50%;
    box-shadow: 0 1px 7px rgba(50, 80, 200, .11);
  }

  @keyframes wishlistBounce {
    0% {
      transform: scale(1);
    }

    45% {
      transform: scale(1.32);
    }

    60% {
      transform: scale(0.88);
    }

    100% {
      transform: scale(1);
    }
  }

  .wishlist-bounce {
    animation: wishlistBounce 0.5s;
  }

  /* Responsive widths */
  @media (max-width: 570px) {
    .product-card {
      flex: 0 0 calc(50% - 8px);
      /* 2 per row */
    }
  }

  @media (min-width: 571px) and (max-width: 700px) {
    .product-card {
      flex: 0 0 calc(33% - 12px);
      /* 4 per row */
    }
  }

  @media (min-width: 701px) and (max-width: 991px) {
    .product-card {
      flex: 0 0 calc(25% - 12px);
      /* 4 per row */
    }
  }

  @media (min-width: 992px) {
    .product-card {
      flex: 0 0 calc(16% - 13px);
      /* 5 per row */
    }
  }
</style>

{% endblock %}