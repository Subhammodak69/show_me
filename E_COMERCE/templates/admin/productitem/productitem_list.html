{% extends 'admin/home.html' %}
{% load static %}

{% block title %}Product Items | Show_me{% endblock %}

{% block content %}
<div class="container mt-5">
  <h2 class="mb-4">All Product Items</h2>

  <div class="mb-3 text-end">
    <a href="{% url 'productitem_create' %}" class="btn btn-success">+ Add Product Item</a>
  </div>

  <table class="table table-bordered table-hover shadow-sm bg-white rounded">
    <thead class="table-light">
      <tr>
        <th>ID</th>
        <th>Product</th>
        <th>Size</th>
        <th>Color</th>
        <th>Price (â‚¹)</th>
        <th>Image</th>
        <th>Availability</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for item in productitems %}
      <tr>
        <td>{{ item.id }}</td>
        <td>{{ item.product.name }}</td>
        <td>{{ item.size }}</td>
        <td>{{ item.color }}</td>
        <td>{{ item.price }}</td>
        <td><img src="{{ item.photo_url }}" alt="Product Image" style="    object-fit: cover;width: 70px;height: 70px;"></td>
        <td>{{ item.availibility }}</td>
        <td>
          <span id="status-badge-{{ item.id }}" class="badge {% if item.is_active %}bg-success{% else %}bg-danger{% endif %}">
            {% if item.is_active %}Active{% else %}Inactive{% endif %}
          </span>
        </td>
        <td>
          <a href="{% url 'productitem_update' item.id %}" class="btn btn-sm btn-warning me-1">Update</a>
          <button id="toggle-btn-{{ item.id }}"
                  class="btn btn-sm {% if item.is_active %}btn-danger{% else %}btn-success{% endif %}"
                  onclick="toggleProductItemStatus({{ item.id }}, {{ item.is_active|yesno:'true,false' }})">
            {% if item.is_active %}Deactivate{% else %}Activate{% endif %}
          </button>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="9" class="text-center">No product items found.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
  async function toggleProductItemStatus(itemId, currentStatus) {
    try {
      const response = await fetch(`/admin/productitem/toggle-status/${itemId}/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}',
        },
        body: JSON.stringify({ is_active: !currentStatus })
      });

      const result = await response.json();

      if (result.success) {
        const newStatus = result.new_status;

        // Update badge
        const badge = document.getElementById(`status-badge-${itemId}`);
        badge.textContent = newStatus ? 'Active' : 'Inactive';
        badge.className = `badge ${newStatus ? 'bg-success' : 'bg-danger'}`;

        // Update button
        const button = document.getElementById(`toggle-btn-${itemId}`);
        button.textContent = newStatus ? 'Deactivate' : 'Activate';
        button.className = `btn btn-sm ${newStatus ? 'btn-danger' : 'btn-success'}`;
        button.setAttribute('onclick', `toggleProductItemStatus(${itemId}, ${newStatus})`);
      } else {
        alert(result.error || 'Status update failed.');
      }
    } catch (error) {
      alert('Server error occurred.');
    }
  }
</script>
{% endblock %}
