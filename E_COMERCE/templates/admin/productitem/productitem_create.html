{% extends 'admin/home.html' %}
{% load static %}
{% block title %}Product Item Create | Show_me{% endblock %}

{% block content %}
<div class="container mt-5"style="max-width: 600px;">
  <h2>Create Product Item</h2>

  <form id="create-form" enctype="multipart/form-data" method="post">
    {% csrf_token %}
    
    <!-- Product Select -->
    <div class="mb-3">
      <label for="product">Product</label>
      <select id="product" name="product" class="form-control" required>
        <option value="">-- Select Product --</option>
        {% for p in products %}
          <option value="{{ p.id }}">{{ p.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="mb-3">
      <label class="form-label">Brand</label>
      <input type="text" name="brand" class="form-control" required>
    </div>

    <div class="mb-3">
      <label class="form-label">Price</label>
      <input type="number" name="price" class="form-control" required>
    </div>

  <!-- Image File Input -->
    <label for="photo">Upload Photo</label>
    <input 
      class="form-control mb-2" 
      type="file" 
      id="photo" 
      name="photo" 
      accept="image/*" 
      required 
    />

    <!-- Optional: Image preview -->
    <img id="preview" class="my-3" style="max-height: 150px; display:none;" />

    <button type="submit" class="btn btn-primary">Create</button>
  </form>

  <div id="response" class="mt-3"></div>
</div>

<script>
  document.getElementById("photo").addEventListener("change", function() {
    const file = this.files[0];
    const preview = document.getElementById("preview");

    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        preview.src = e.target.result;
        preview.style.display = "block";
      };
      reader.readAsDataURL(file);
    }
  });

  document.getElementById("create-form").addEventListener("submit", async function(e) {
    e.preventDefault();

    const form = e.target;    
    const formData = new FormData(form);
    const loader = document.querySelector('.loading');
    loader.style.display='flex';
    const response = await fetch("{% url 'productitem_create' %}", {
      method: "POST",
      headers: {
        'X-CSRFToken':'csrfToken'
      },
      body: formData,
    });

    const result = await response.json();

    if (result.success) {
    loader.style.display='none';

      window.location.href = "{% url 'productitem_list' %}";
    } else {
    loader.style.display='none';

      const responseDiv = document.getElementById("response");
      responseDiv.innerHTML = `<div class="alert alert-danger">${result.error || 'An error occurred.'}</div>`;
    }
  });
</script>
{% endblock %}
