{% extends 'admin/home.html' %}
{% load static %}
{% block title %}Product Item Create | Show_me{% endblock %}

{% block content %}
<div class="container mt-5">
  <h2>Create Product Item</h2>

  <form id="create-form" enctype="multipart/form-data" method="post">
    {% csrf_token %}
    
    <!-- Product Select -->
    <div class="mb-3">
      <label for="product">Product</label>
      <select id="product" name="product" class="form-control" required>
        <option value="">-- Select Product --</option>
        {% for p in products %}
          <option value="{{ p.id }}">{{ p.name }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Size Dropdown -->
    <div class="mb-3">
      <label for="size">Size</label>
      <select id="size" name="size" class="form-control" required>
        <option value="">-- Select Size --</option>
        {% for label, value in sizes.items %}
          <option value="{{ value }}">{{ label }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Color Dropdown -->
    <div class="mb-3">
      <label for="colour">Colour</label>
      <select id="colour" name="colour" class="form-control" required>
        <option value="">-- Select Colour --</option>
        {% for label, value in colours.items %}
          <option value="{{ value }}">{{ label }}</option>
        {% endfor %}
      </select>
    </div>

    <input 
      class="form-control mb-2" 
      placeholder="Price" 
      type="number" 
      id="price" 
      name="price" 
      required 
      min="0"
    />
    <input 
      class="form-control mb-2" 
      placeholder="Availability" 
      type="number" 
      id="availibility" 
      name="availibility" 
      required 
      min="0"
    />

    <!-- Image File Input -->
    <label for="photo">Upload Photo</label>
    <input 
      class="form-control mb-2" 
      type="file" 
      id="photo" 
      name="photo" 
      accept="image/*" 
      required 
    />

    <!-- Optional: Image preview -->
    <img id="preview" class="my-3" style="max-height: 150px; display:none;" />

    <button type="submit" class="btn btn-primary">Create</button>
  </form>

  <div id="response" class="mt-3"></div>
</div>

<script>
  document.getElementById("photo").addEventListener("change", function() {
    const file = this.files[0];
    const preview = document.getElementById("preview");

    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        preview.src = e.target.result;
        preview.style.display = "block";
      };
      reader.readAsDataURL(file);
    }
  });

  document.getElementById("create-form").addEventListener("submit", async function(e) {
    e.preventDefault();

    const form = e.target;    
    const formData = new FormData(form);
    
    const response = await fetch("{% url 'productitem_create' %}", {
      method: "POST",
      headers: {
        'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: formData,
    });

    const result = await response.json();

    if (result.success) {
      window.location.href = "{% url 'productitem_list' %}";
    } else {
      const responseDiv = document.getElementById("response");
      responseDiv.innerHTML = `<div class="alert alert-danger">${result.error || 'An error occurred.'}</div>`;
    }
  });
</script>
{% endblock %}
