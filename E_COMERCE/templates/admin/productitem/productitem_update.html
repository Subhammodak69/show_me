
{% extends 'admin/home.html' %}
{% load static %}
{% block title %}Update Product Item{% endblock %}

{% block content %}
<div class="container mt-5" style="max-width: 600px;">
  <h2 class="mb-4">Update Product Item</h2>

  <form id="update-form" enctype="multipart/form-data">
    {% csrf_token %}

    <div class="mb-3">
      <label class="form-label">Product</label>
      <select name="product" class="form-select" required>
        {% for p in products %}
          <option value="{{ p.id }}" {% if item.product.id == p.id %}selected{% endif %}>
            {{ p.name }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="mb-3">
      <label class="form-label">Brand</label>
      <input type="text" name="brand" class="form-control" value="{{item.brand}}" required>
    </div>
    <div class="mb-3">
      <label class="form-label">Price</label>
      <input type="number" name="price" class="form-control" value="{{ item.price }}" required>
    </div>


    <div class="mb-3">
      <label class="form-label">Current Image</label><br>
      <img src="{{ item.photo_url }}" style="max-height: 150px;">
    </div>

    <div class="mb-3">
      <label class="form-label">Change Image</label>
      <input type="file" name="photo" accept="image/*" class="form-control">
    </div>

    <button type="submit" class="btn btn-primary">Update</button>
  </form>

  <div id="update-msg" class="mt-3"></div>
</div>

<script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== "") {
    const cookies = document.cookie.split(";");
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === name + "=") {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

document.getElementById("update-form").addEventListener("submit", async function (e) {
  e.preventDefault();

  const form = e.target;
  const formData = new FormData(form);
  const csrfToken = getCookie("csrftoken");
  const loader = document.querySelector('.loading');
    loader.style.display='flex';
  try {
    const response = await fetch("{{ request.path }}", {
      method: "POST",
      headers: {
        "X-CSRFToken": csrfToken,
      },
      body: formData,
    });

    const rawText = await response.text();
    console.log("Raw Response:", rawText);  // Debug output

    let result;
    try {
      result = JSON.parse(rawText);
    } catch (err) {
              loader.style.display='none';

      throw new Error("Invalid JSON returned by server");
    }

    if (result.success) {
              loader.style.display='none';

      window.location.href = "{% url 'productitem_list' %}";
    } else {
              loader.style.display='none';

      document.getElementById("update-msg").innerText = result.message || "Update failed.";
    }
  } catch (error) {
            loader.style.display='none';

    console.error("Fetch error:", error);
    document.getElementById("update-msg").innerText = "Something went wrong. Please try again.";
  }
});
</script>

{% endblock %}
